import os
import asyncio
import re
import requests
from colorama import Fore,init
from datetime import datetime

init()

##################################################################
#* Creates a regex pattern
capturesERRBASED = []
pattern = r"\berror\b"
htmlpattern = r"\bid\b"
########################################################
  
async def Error_based_inj(urls):
    """This is for error based SQL injection. You can realize to the SQL structure by this Injection if it works."""
    try: 
        global pattern,htmlpattern #* Declare the lists as an global variable
        done = False #* Creates flag False for the done value
        filename = "Error_based.txt" #* This is a file that is on the same directory as the python file
        current_directory = os.path.dirname(os.path.abspath(__file__)) #* Obtain current directory
        file_path = os.path.join(current_directory, filename) #* Obtain the file path
        #! We do that because we cannot count on the initial directory path so we need the precise of it on any device

        with open(file_path, "r") as file: #* Opens the file as read mode
            payload = file.read() #* Reads the file
            rows = payload.split("\n") #* Splits the rows with \n
            sorted_rows = sorted(rows) #* Sort the lists
            sorted_payload = "\n".join(sorted_rows) #* Join the program
            print(Fore.RED + str(sorted_payload)) #* Display the payload
            requests.packages.urllib3.disable_warnings()  # *Disable SSL warnings for the practice
            # url = "https://redtiger.labs.overthewire.org/level1.php"
            req = requests.get(url=urls,verify=False)
            if req.status_code == 200:
                ask = input(f"[{datetime.now()}]",Fore.GREEN + "Looks like the host is up with the ip address: {socket.gethostbyname(url)} Do you want to send the payload to the website? ")

                if ask.lower() == "y":
                    for line in sorted_payload.split("\n"):
                        #############################################################33
                        params = {
                            "username": line,
                            "password": line
                        }
                        ##############################################################################
                        # print(line) #*  We may need that 
                        ack = requests.post(url=urls, data=params,verify=False)
                        print(f"[{datetime.now()}]","|Current payload: |", line,"|with status code|:",ack.status_code)
                        print(f"[{datetime.now()}]",Fore.GREEN + str(ack.status_code))
                        await asyncio.sleep(5)
                        if "error" in ack.text:
                            print(f"[{datetime.now()}]",Fore.RED + "|Vulnerability found|:", ack.text)
                            
                        vuln = re.findall(ack.text,pattern,flags=re.IGNORECASE)
                        htmlVULN = re.findall(ack.text,htmlpattern,flags=re.IGNORECASE)
                        if vuln:
                            print(f"[{datetime.now()}]",Fore.RED + " | Vulnerability found: |", ack.text," | with the count of: |",len(vuln))
                            await asyncio.sleep(3)
                        
                        if htmlVULN:
                            print(f"[{datetime.now()}]",Fore.RED + "|Vulnerability found|:", ack.text,"with the count of:",len(htmlVULN))
                            await asyncio.sleep(3)
                        
                        word = "id" in req.text
                        errword = "error" in req.text
                        if word:
                            print(f"[{datetime.now()}]",Fore.GREEN + "|Vulnerability found|:", ack.text,"with the count of:",len(htmlVULN))
                            await asyncio.sleep(3)
                        
                        if errword:
                            print(f"[{datetime.now()}]",Fore.RED + "|Vulnerability found|:", ack.text,"with the count of:",len(htmlVULN))
                            await asyncio.sleep(3)
                            
                        
                            
                    if req.status_code == 302:
                        print(f"[{datetime.now()}]","Could inject the sq;; to the website:",line)
                        done = True
                        
            else:
                print(f"[{datetime.now()}]",Fore.RED + "Looks like the host is down with the ip address: {socket.gethostbyname(url)}")
                        
                    
    except Exception as e:
        print(f"[{datetime.now()}]",Fore.RED+"[ERROR]Error:".e)
        
    except ConnectionAbortedError as e:
        print(f"[{datetime.now()}]",Fore.RED+"[ERROR]Error:",e)
        
    except ConnectionError as e:
        print(f"[{datetime.now()}]",Fore.RED+"[ERROR]Error:",e)
        
    except ConnectionRefusedError as e:
        print(f"[{datetime.now()}]",Fore.RED+"[ERROR]Error:",e)
    
    except ConnectionResetError as e:
        print(f"[{datetime.now()}]",Fore.RED+"[ERROR]Error:",e)
        
    except KeyboardInterrupt:
        print(f"[{datetime.now()}]","Exiting...")
        raise SystemExit
    
    finally:
        global capturesERRBASED
        print(f"[{datetime.now()}]",Fore.BLUE+f"""[INFO] The final result of html response:
                    \n{ack.text}\n     """)
        capturesERRBASED.append(ack.text)

                            
                            
# asyncio.run(Error_based_inj())